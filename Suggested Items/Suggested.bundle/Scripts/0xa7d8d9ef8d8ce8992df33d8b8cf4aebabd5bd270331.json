{
  "kind" : "three",
  "screensaverFileName" : "Metropixeland",
  "value" : "const hash=tokenData.hash,tokenId=Math.min(449,tokenData.tokenId%1000),PI=Math.PI,TC=THREE.Color,FL=Math.floor,ABS=Math.abs,xS=Uint32Array.from([0,0,0,0].map((e,r)=>parseInt(hash.substring(8*r+2,8*r+10),16))),prng=e=>{let r,t=xS[3];return xS[3]=xS[2],xS[2]=xS[1],xS[1]=r=xS[0],t^=t<<11,t^=t>>>8,xS[0]=t^r^r>>>19,FL(e*(xS[0]\/4294967296))},prand=(e,r)=>e+prng(r-e);const V2=(x,y)=>new THREE.Vector2(x,y);var palette=!prng(6),palnumber=prng(7),rainbowWalls=!palette&&!prng(40),sakuraTrees=!prng(16),randTrees=!sakuraTrees&&!prng(4),drive=prng(3)?-1:1,bus=1==drive&&!prng(3),rainbow=!prng(14),traffic=prng(4);const vertexShader=\"precision highp float;attribute vec2 position;void main(){gl_Position=vec4(position,1.,1.);}\",fragmentShader=\"precision highp float;uniform sampler2D uScene;uniform vec2 uResolution;\\nfloat random(vec2 p){return fract(cos(dot(p,vec2(23.14,2.665)))*12345.6789);}void main(){vec2 uv=gl_FragCoord.xy\/uResolution.xy;vec4 color=texture2D(uScene,uv);float step_u=1.\/uResolution.x;float step_v=1.\/uResolution.y;vec4 cRight=texture2D(uScene,uv+vec2(step_u,0.));vec4 cBottom=texture2D(uScene,uv+vec2(0.,step_v));float _dFdx=length(color-cRight)\/step_u;float _dFdy=length(color-cBottom)\/step_v;\\nfloat g=sqrt(pow(_dFdx,2.)+pow(_dFdy,2.))*.006;if(g>.4 && uResolution.x>350.)color.rgb*=max(.5,1.-(uResolution.x-350.)\/500.);color.rgb*=1.1-.8*(sqrt(pow(.5-uv.x,2.)+pow(.5-uv.y,2.)));vec2 uvRandom=uv;uvRandom.y*=random(vec2(uvRandom.y,1.));color.rgb+=random(uvRandom)*.06;gl_FragColor=color;}\";class FX{constructor(e){this.r=e,this.s=new THREE.Scene,this.dC=new THREE.Camera,this.r.setPixelRatio(window.devicePixelRatio),this.r.antialias=!1,this.res=new THREE.Vector2,this.t=new THREE.WebGLRenderTarget(this.res.x,this.res.y,{format:THREE.RGBAFormat,stencilBuffer:!1,depthBuffer:!0}),this.m=new THREE.RawShaderMaterial({fragmentShader:fragmentShader,vertexShader:vertexShader,uniforms:{uScene:{value:this.t.texture},uResolution:{value:this.res}}}),this.p=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),this.m),this.p.frustumCulled=!1,this.s.add(this.p),this.resize()}resize(){this.r.getDrawingBufferSize(this.res),this.m.uniforms.uResolution.value=this.res,this.t.setSize(this.res.x,this.res.y)}render(e,r){this.r.setRenderTarget(this.t),this.r.clear(),this.r.render(e,r),this.r.setRenderTarget(null),this.r.render(this.s,this.dC)}}var clock=new THREE.Clock,width=window.innerWidth,height=window.innerHeight;const R=new THREE.WebGLRenderer({premultipliedAlpha:!1,alpha:!0});R.autoClear=!1,R.setPixelRatio(window.devicePixelRatio),R.setSize(width,height),document.body.appendChild(R.domElement);const SC=new THREE.Scene;var tex1=new THREE.Texture(generateTexture());tex1.needsUpdate=!0,tex1.anisotropy=R.capabilities.getMaxAnisotropy(),tex1.wrapT=tex1.wrapS=THREE.RepeatWrapping;var w=.1+prng(10)\/40,m=new THREE.ShaderMaterial({uniforms:{wind:{value:prng(2)?w:-w},cycle:{value:0},c1:{value:0},c2:{value:0},dt:{value:prng(1e3)}},vertexShader:\"precision highp float;varying vec2 vUv;void main(){vUv=uv;gl_Position=vec4(position,1.);}\",fragmentShader:\"precision highp float;uniform sampler2D uScene;uniform float wind;uniform float dt;uniform float cycle;varying vec2 vUv;uniform vec3 c1,c2;float hash(float n){return fract(sin(n)*758.5453);}float noise(in vec3 x){vec3 p=floor(x);vec3 f=fract(x);float n=p.x+p.y*57.+p.z*800.;float res=mix(mix(mix(hash(n+0.),hash(n+1.),f.x),mix(hash(n+57.),hash(n+ 58.),f.x),f.y),mix(mix(hash(n+800.),hash(n+801.),f.x),mix(hash(n+857.),hash(n+858.),f.x),f.y),f.z);return res;}float fbm(vec3 p){float f=.5*noise(p);p*=1.39+cycle;for(float i=.25;i>.03;i\/=2.){f+=i*noise(p);p*=2.02;}return f;}float borealCloud(vec3 p){p+=fbm(vec3(p.x,p.y,0.0)*0.5)*2.25;float a=smoothstep(.0,.9,fbm(p*2.)*2.2-1.1);return clamp(a,0.,1.);}void main(){float sp=dt*.1;vec4 color=vec4(mix(c1,c2,1.-vUv.y),1.);if(cycle>2.) color.g+=(borealCloud(vec3(vUv.x,vUv.y*.27,sp*.5))*clamp(2.*(vUv.y-(.5+.1*cos((vUv.x+sp)*6.))),0.,1.)); else color+=borealCloud(vec3(vUv.x+sp*wind,vUv.y*1.5,sp*wind*2.))*clamp((vUv.y-.5)*2.,0.,1.);gl_FragColor=color;}\"}),bgplane=new THREE.Mesh(new THREE.PlaneGeometry(2,2),m);SC.add(bgplane);const ethpal=[16711680,16746240,16765696,14614282,10616586,720793,716799,1342965,5769983,12454655],ethcol=ethpal[prng(10)],c1s=[5942001,873670,1516381,331314],c2s=[16755200,6931446,15108792,3488657],pal=setBG(tokenId);function setBG(e){let r=[0,27,90,247,292,315,337,450],t=0;for(;e>=r[t];)t++;let o=FL(t\/2),n=FL((t-1)\/2),a=(e-r[t-1])\/(r[t]-r[t-1]);return m.uniforms.c1.value=new TC(c1s[n]).lerp(new TC(c1s[o]),a),m.uniforms.c2.value=new TC(c2s[n]).lerp(new TC(c2s[o]),a),m.uniforms.cycle.value=o,o}const palettes=[[16777215,65484,10263708,13421772,16777215],[5263955,16777215,8350828,9144713,10658713],[46079,16514816,6984879,7517135,9356237],[10481022,15728257,5073487,7647099,11989670],[16724818,13225378,12605785,13343888,14393247],[16769858,16774072,9935176,12565583,13223227],[13191836,15007150,13071576,16692464,15119332]];var citypal=palettes[palnumber],numbers=[31599,9362,29671,29391,23497,31183,31215,29257,31727,31695],pats=new Array,numpat=1+5*prng(4);for(let e=0;e<numpat;e++)pats.push(randPat(6,6+3*prng(4),prng(3)));function randPat(e,r,t=1){let o=new Array(r);for(let t=0;t<r;t++)o[t]=new Array(e);if(t)for(let t=0;t<r;t+=3)for(let r=0;r<e;r++){o[t][r]=1;let e=r%2||prng(4)?0:1;o[t+1][r]=o[t+2][r]=e}else for(let t=0;t<r;t++)for(let r=0;r<e;r+=3){o[t][r]=1;let e=t%2&&!prng(2)?1:0;o[t][r+1]=o[t][r+2]=e}return o}var rPat=()=>pats[prng(pats.length)];const MLM=(e=0)=>new THREE.MeshLambertMaterial({color:0,emissive:0==e?0:16777215,emissiveIntensity:e});var M={walls:MLM(),dirt:MLM(),ground:MLM(),water:MLM(.02),core:MLM(.8),sidewalk:MLM(),vehicle:MLM(),rail:MLM(),panel:MLM(.4),neon:MLM(2),neon1:MLM(2),neon2:MLM(2),tree1:MLM(),tree2:MLM(),tree3:MLM(.15),cesped:MLM()};M.water.map=tex1;const COL=(e,r,t)=>new TC(\"hsl(\"+e+\", \"+r+\"%,\"+t+\"%)\");randColors();var rainbowRocks=!1;function randColors(){for(const e in M)M[e].color.set(prng(16777215));M.walls.color.set(COL(prand(50,360)+130,prand(20,60),prand(50,70))),M.core.color.set(COL(prand(10,100),prand(20,50),prand(50,95)));let e=prng(330);M.sidewalk.color.set(COL(e+20,15,60)),M.ground.color.set(COL(e,5,50)),e=prng(360),M.vehicle.color.set(COL(e,100,65)),M.rail.color.set(COL(e,100,80)),M.dirt.color.set(COL(prand(30,100),prand(30,80),80)),M.water.color.set(COL(prand(140,210),100,50)),M.tree1.color.set(COL(prng(60),100,40)),M.tree2.color.set(COL(prand(60,165),100,prand(40,70))),M.tree3.color.set(COL(320,100,60)),M.cesped.color.set(COL(prand(75,165),100,prand(40,70))),M.neon.color.set(COL(0,0,100));let r=prand(10,200);M.neon.emissive.set(COL(r,100,FL(50+10*Math.cos(3*r*PI\/180)))),M.neon1.emissive.set(COL(prng(360),100,prand(30,60))),M.neon2.emissive.set(COL(prng(360),100,prand(30,60))),M.core.emissive.set(COL(prand(30,210),90,prand(80,100)))}palette&&(rainbowRocks=5==palnumber,M.walls.color.set(citypal[0]),M.core.color.set(citypal[1]),M.ground.color.set(citypal[2]),M.sidewalk.color.set(citypal[3]),M.dirt.color.set(citypal[4]));var post=new FX(R);const C=new THREE.OrthographicCamera(width\/-2,width\/2,height\/2,height\/-2,1e-4,1e4);var scale=350;C.zoom=Math.min(width,height)\/scale,C.updateProjectionMatrix();var H,eth,RX=PI\/6,RY=.75*PI,rotX=RX,rotY=RY,G=new THREE.Group,city=new THREE.Group,grid=2.15,gx=96,gz=96,cx=gx*grid*.5,cz=gz*grid*.5,border=6,minrec=15,gotHeli=!1,rtrees=prng(2),fam=prng(6),randFam=prng(2),lights=[],trains=[],roads=new Array(17);for(let e=0;e<17;e++){roads[e]=new Array(17);for(let r=0;r<17;r++)roads[e][r]={v:1,d:[]}}var cars=[],ele=[],ppl=0,blinking=!0,rf=-1+prng(30),reduc=1+prng(2);let offs=FL(border\/2-1);if(prng(2)&&(mr([gx+4,1,1],[offs,16,offs+gz\/2]),train({x:offs+5+prng(gx\/2-10),y:15,z:gz\/2+offs-1.5},0)),prng(2)&&(mr([1,1,gz+2],[offs+gx\/2,8,0]),train({x:offs-1.5+gx\/2,y:7,z:offs+15+prng(gz\/2-10)},1)),prng(2)){mr([1,1,gz+border],[offs,0,-.1]),train({x:offs-1.5,y:-1,z:offs+15+prng(gz\/2-10)},1);for(let e=0;e<17;e++)roads[0][e].v=0}if(prng(2)||rainbow){mr([gx+border,1,1],[-.1,0,offs]),train({x:offs+15+prng(gx\/2-10),y:-1,z:offs-1.5},0);for(let e=0;e<17;e++)roads[e][0].v=0}rec({x:gx,y:96,z:gz},{x:0,y:0,z:0}),G.add(B([gx+border,1,gz+border],[0,-.3,0],M.ground));let gh=10,levels=8;for(let e=1;e<=levels;e++)prng(e+1)?rLev(gh,{x:0,y:-gh*e-.3,z:0}):uLev(gh,{x:0,y:-gh*e-.3,z:0});G.add(B([gx+border,500,gz+border],[0,-500-gh*levels-.3,0],M.dirt));let nuc=new THREE.Group;nuc.add(B([gx+border+1e3,400,gz+border+10],[-500,-600-gh*levels-.3,-10],M.water));for(let e=0;e<500;e+=10)nuc.add(B([10,350+5*prng(10),10],[-250+e,-600-gh*levels-.3,-15],M.dirt));G.add(nuc.rotateY(PI\/4)),SC.add(B([20,20,20],[-10,380,-50],new THREE.MeshLambertMaterial({color:16768256,emissive:pal>1?16777215:16768256,emissiveIntensity:1}))),dN(tokenId,-1,1.7,gz+border-2,1,!0);const ld=prng(2),l=new THREE.DirectionalLight(16777215,.9);l.position.set(ld?3:-3,4,4),SC.add(l);const l2=new THREE.DirectionalLight(c2s[pal],.2);l2.position.set(ld?-1:1,3,8),SC.add(l2),G.position.set(-cx,0,-cz),city.position.set(0,-60,-800),city.rotation.set(rotX,rotY,0),city.add(G),SC.add(city);var txt=\"\",h=[0];for(let e=0;e<6;e++)h.push(prng(4)?prng(8):0);h.push(0);w=[\"::\",\".:\",\":.\",\": \",\" :\",\". \",\" .\",\"..\"];for(let e=8;e>=0;e--){for(let r=0;r<h.length;r++)txt+=h[r]>e?\"|\"+(e>0?w[prng(w.length)]:prng(2)?\"n_\":\"__\"):(r>0&&e<h[r-1]?\"|\":e>0?\" \":\"_\")+(h[r]==e?e&&!prng(3)?\"_|\":\"__\":prng(6)||e<6?\"  \":\" ~\");txt+=\"\\n\"}function moveCar(e){for(let r of cars)if(r.x+=r.v*r.d[0]*e,r.z+=r.v*r.d[1]*e,r.model.position.x=(6*r.x+border\/2)*grid,r.model.position.z=(6*r.z+border\/2)*grid,r.model.rotation.y=1==r.d[0]?PI\/2:-1==r.d[0]?-PI\/2:-1==r.d[1]?PI:0,ABS(r.x-r.t[0])<=r.v*e&&ABS(r.z-r.t[1])<=r.v*e){r.x=r.t[0],r.z=r.t[1];let e,t=roads[r.t[0]][r.t[1]].d;do{e=roads[r.t[0]][r.t[1]].d[Math.floor(Math.random()*t.length)]}while(t.length>1&&r.d[0]==-e[0]&&r.d[1]==-e[1]);let o=r.d;r.d=e,r.t=[r.x+r.d[0],r.z+r.d[1]],-1==drive?(o[0]==e[1]&&(r.z+=.5*e[1]),o[1]+e[0]==0&&(r.x+=.5*e[0])):(o[0]==-e[1]&&(r.z+=.5*e[1]),o[1]==e[0]&&(r.x+=.5*e[0]))}}txt+=\"· #\"+tokenId+`\/449\\n· Population: ${ppl}\\n·\\n· Metropixeland\\n· F.Jerez 2022\\n`;console.clear();console.log(txt);for(let e=0;e<17;e++)for(let r=0;r<17;r++)roads[e][r].v&&(r<16&&roads[e][r+1].v&&roads[e][r].d.push([0,1]),e>0&&roads[e-1][r].v&&roads[e][r].d.push([-1,0]),r>0&&roads[e][r-1].v&&roads[e][r].d.push([0,-1]),e<16&&roads[e+1][r].v&&roads[e][r].d.push([1,0]));for(let e=0;e<2+3*traffic;e++){let e={x:0,z:0,t:[0,0],d:[0,0],v:.6+prng(6)\/10,model:new THREE.Group},r=drive;!bus&&prng(2)?e.model.add(B([2.2,1.5,3],[r-1.1,1.5,-2.1],M.walls)):e.model.add(B([2.1,1,2],[r-1.05,1.5,-1.5],M.neon)),bus?(e.model.add(B([2,4.5,4],[r-1,0,-2],mRW(0))),e.model.add(B([2.1,1,1],[r-1.05,1.5,1.1],M.neon)),e.model.add(B([2.1,1,3.6],[r-1.05,3.2,-1.5],M.neon)),bus=!1):(e.model.add(B([2,2.9,4],[r-1,0,-2],M.vehicle)),e.model.add(B([2.1,1,1],[r-1.05,1.5,1.1],M.neon)));do{e.x=prng(17),e.z=prng(17)}while(0==roads[e.x][e.z].v);e.t=[e.x,e.z],G.add(e.model),cars.push(e)}function rec(e,r){let t=Math.min(e.x,e.z),o=e.x\/e.z,n=e.z\/e.x;Math.max(o,n)<3&&(t<minrec||t<gx\/2&&0==prng(6))?square(e,r):o>.5&&(prng(2)||o>3)?(rec({x:Math.ceil(e.x\/2),y:e.y,z:e.z},{x:r.x+FL(e.x\/2),y:r.y,z:r.z}),rec({x:Math.ceil(e.x\/2),y:e.y,z:e.z},{x:r.x,y:r.y,z:r.z})):(rec({x:e.x,y:e.y,z:Math.ceil(e.z\/2)},{x:r.x,y:r.y,z:r.z}),rec({x:e.x,y:e.y,z:Math.ceil(e.z\/2)},{x:r.x,y:r.y,z:r.z+FL(e.z\/2)}))}function getY(e,r){let t=0;return t=0==r?1.5*e.x-.5*gx:1==r?1.5*e.z-.5*gz:2==r?1.5*Math.max(e.x,e.z)-.5*gz:3==r?Math.min(e.x,e.z):4==r?Math.max(e.x-e.z,e.z-e.x):e.x>=gx\/2&&e.z>=gz\/2?Math.max(e.x,e.z):0,FL(randFam?prng(t)\/reduc:t\/reduc)}function square(e,r){let t=border+2,o=Math.min(e.x,e.z),n=2+FL(getY(r,fam));for(let t=1;t<e.x\/6;t++){roads[FL(r.x\/6+t)][FL(r.z\/6+1)].v=0;for(let o=1;o<e.z\/6;o++)roads[FL(r.x\/6+t)][FL(r.z\/6+o)].v=0}if(prng(n)<2&&(n=1),G.add(B([e.x-border+2,1,e.z-border+2],[border+r.x-1,0,border+r.z-1],M.sidewalk)),r.x&&prng(2))for(let t=2.25;t<=4.25;t++)G.add(B([.5,1,2],[r.x+border-t,0,r.z+e.z-1],M.sidewalk));if(r.z&&prng(2))for(let t=2.25;t<=4.25;t++)G.add(B([2,1,.5],[r.x+e.x-1,0,r.z+border-t],M.sidewalk));if(n>1||!prng(6)){ppl+=n*prand(8,12);let a=r.x+e.x\/2+border\/2+2,d=r.z+e.z\/2+border\/2+2;if(o>minrec&&e.x!=e.z){let i=Math.round(.6*n),l=Math.round(1*n),s=rPat();b({x:o-t,y:n\/2,z:o-t},{x:r.x+t,y:r.y,z:r.z+t},i,s),b({x:o-t,y:n\/2,z:o-t},{x:(e.x>e.z?e.x\/2:0)+r.x+t,y:r.y,z:(e.z>e.x?e.z\/2:0)+r.z+t},i,s,0,!1);let p=e.x\/2-border,g=e.z\/2-border;b({x:p,y:e.y,z:g},{x:a-p\/2,y:r.y+i+4,z:d-g\/2},l,-1,2),G.add(B([p+1,i+5,g+1],[a-p\/2+.02,r.y,d-g\/2+.02],M.core)),G.add(B([2,i+7,2],[a-(g>p?p\/2+1:2),r.y,d-(g<p?g\/2+1:2)],M.walls))}else{let t=!1;if(o>minrec){t=!0;let o=r.y+n+2.1;G.add(B([7,1,1],[a-5,o,d-4],M.neon)),G.add(B([7,1,1],[a-5,o,d],M.neon)),G.add(B([1,1,3],[a-2,o,d-3],M.neon)),G.add(B([2,1,2],[r.x+border+2,o,r.z+border+2],M.neon3)),G.add(B([2,1,2],[r.x+e.x-border+2,o,r.z+border+2],M.neon3)),G.add(B([2,1,2],[r.x+border+2,o,r.z+e.x-border+2],M.neon3)),G.add(B([2,1,2],[r.x+e.x-border+2,o,r.z+e.z-border+2],M.neon3)),n>12&&!gotHeli?heli({x:a-2,y:r.y+n+3.5,z:d-2}):pond({x:e.x-border-3,y:e.y,z:e.z-border-3},{x:r.x+border+1.5,y:r.y+n+2,z:r.z+border+1.5},2,M.core),gotHeli=!0}else if(n>30&&!prng(2)&&e.x>e.z){for(let e=3;e>=1.5;e-=1.5)G.add(B([1,n+3,.5],[r.x+border-.2,r.y,d-e],M.walls,0));let e={miny:2*grid,maxy:n*grid,delay:0,stop:2+prng(4),dir:prng(2)?-5:5,model:new THREE.Group};e.model.position.set((r.x+border-1.5)*grid,(4+prng(n-6))*grid,(d-3)*grid),e.model.add(B([1.5,2,1.6],[0,0,.2],M.core,0)),e.model.add(B([1.5,.3,2],[0,2,0],M.walls,0)),e.model.add(B([1.5,1,2],[0,-1,0],M.walls,0)),ele.push(e),G.add(e.model)}b({x:e.x-border,y:e.y,z:e.z-border},{x:r.x+border,y:r.y,z:r.z+border},n,-1,0,!0,t)}}else if(Math.min(e.x,e.z)<minrec)for(let t=border+1;t<Math.max(e.x,e.z);t+=5){let o=e.x>e.z?r.x+t:r.x+(e.x+border)\/2-1,n=e.x>e.z?r.z+(e.z+border)\/2-1:r.z+t;tree(o,r.y,n)}else prng(2)||e.x!=e.z?prng(2)?park(e,r):tenp(e,r):pond({x:e.x-border,y:e.y,z:e.z-border},{x:r.x+border,y:r.y,z:r.z+border},2,M.water)}function mr(e,r){let t=e[2]>1;if(G.add(B(e,r,M.rail)),r[1]>0)for(let e=5;e<=110;e+=24)monoarc([t?r[0]:Math.min(e,94),r[1],t?Math.min(e,95):r[2]],t)}function monoarc(e,r=!1){let t=M.rail,o=e[1],n=r?3:0,a=r?0:3;G.add(B([3,1,3],[e[0]+n-.85*n,e[1]-1,e[2]+a-.85*a],t)),G.add(B([r?1:3,o-1,r?3:1],[e[0]+n,0,e[2]+a],t)),G.add(B([1,o-1.1,1],[e[0]+n+(r?-.25:1),0,e[2]+a+(r?1:-.25)],M.neon))}function mRW(e){return new THREE.MeshLambertMaterial({color:ethpal[e]})}function train(e,r=0){let t=rainbow?5:prand(3,6),o=new THREE.Group,n=M.neon.clone();if(r){for(let r=0;r<t;r++)o.add(B([2,2,6],[e.x+1,e.y+2.7,6.5*r],rainbow?mRW(2*r):M.vehicle)),o.add(B([1,.8,4.5],[e.x+.7,e.y+3.5,6.5*r+.5],M.neon));o.add(B([1.5,2,6.5*t+.5],[e.x+1.3,e.y+1.7,-.5],n)),o.position.z=e.z*grid}else{for(let r=0;r<t;r++)o.add(B([6,2,2],[6.5*r,e.y+2.7,e.z+1],rainbow?mRW(2*r):M.vehicle)),o.add(B([4.5,.8,1],[6.5*r+.5,e.y+3.5,e.z+.7],M.neon));o.add(B([6.5*t+.5,2,1.5],[-.5,e.y+1.7,e.z+1.3],n)),o.position.x=e.x*grid}trains.push({z:r,t:o,v:prand(10,16)*(prng(2)?1:-1),l:6.5*t,d:0,m:n,w:!0,broken:prand(20,120)}),G.add(o),rainbow=!1}function dN(e,r,t,o,n,a=!1){let d=tokenId,i=0;do{let e=numbers[d%10],l=new THREE.Group,s=M.neon;blinking&&!prng(3)&&(s=s.clone(),lights.push(s),blinking=!1);for(let d=0;d<15;d++)1&e&&l.add(B([n,n,n],[a?r-.2:r+i+n*(d%3),t+2+n*FL(d\/3),a?o-(i+n*(d%3)):o+.7],s,0)),e>>=1;G.add(l),i+=4*n,d=FL(d\/10)}while(d>0);G.add(B([1,7,i+1],[r,t+1,o-i+1],M.panel,0)),G.add(B([1,9,1],[r+1,t-1,o-i+3],M.panel,0)),G.add(B([1,9,1],[r+1,t-1,o-1],M.panel,0))}function rLev(e,r){G.add(B([gx+border,e,gz+border],[r.x,r.y,r.z],M.dirt));for(let t=0;t<2;t++){let t=2;for(;t<gx;){let o=prand(1,5);for(let n=0;n<2;n++){let a=r.y+1+prng(e-o),d=r.z-(.2+prng(5)\/7);G.add(B([o,o,3],[r.x+t,a,d],M.ground,n)),o>1&&prng(1-FL(r.y\/10))>1&&palette&&G.add(B([o\/2,o\/2,3],[r.x+t+o\/4,a+o\/4,d-.6],prng(2)&&rainbowRocks?mRW(prng(ethpal.length)):M.walls,n))}t+=o+1+prng(6)}}sewers(e,r)}function uLev(e,r){let t=border;G.add(B([gx,gh,gz],[r.x+4,r.y,r.z+4],M.core)),G.add(B([gx+t\/2,1,gz+t\/2],[r.x+2.5,r.y+1.5,r.z+2.5],M.sidewalk)),G.add(B([gx+t,2,gz+t],[r.x,r.y,r.z],M.dirt)),G.add(B([gx+t,2,gz+t],[r.x,r.y+e-2,r.z],M.dirt)),G.add(B([6+prng(gx\/4),e-2,6+prng(gx\/4)],[r.x,r.y+1,r.z],M.dirt));let o=5+prng(gx\/4);G.add(B([o,e-2,1],[r.x+t+gx-o,r.y+1,r.z],M.dirt)),G.add(B([1,e-2,o],[r.x,r.y+1,r.z+t+gx-o],M.dirt));let n=15+prng(gx\/3);train({x:n,y:r.y,z:r.z},0),train({x:r.x,y:r.y,z:n},1),sewers(e,r)}function sewers(e,r){for(let t=0;t<2;t++){let o=r.x+1+prng(gx),n=r.y+3,a=2+prng(4),d=4,i=prng(4);for(let l=0;l<i&&o<gx-a-5;l++)G.add(B([a,e-2,1],[o+2,r.y+1,r.z+1],M.dirt,t)),G.add(B([a+6,e-2,1],[o-1,r.y+1,r.z],M.dirt,t)),G.add(B([a,1,d],[o+2,n+3,r.z-d],M.walls,t)),G.add(B([a+2,1,d],[o+1,n,r.z-d],M.walls,t)),G.add(B([1,3,d],[o+1,n,r.z-d],M.walls,t)),G.add(B([1,3,d],[o+a+2,n,r.z-d],M.walls,t)),G.add(B([a,1,3],[o+2,n+1,r.z-d],M.water,t)),G.add(B([a,302,1],[o+2,n-300,r.z-d-1],M.water,t)),o+=a+4,a=2+prng(4)}}function heli(e){let r=new THREE.Group,t=new THREE.Group,o=new THREE.Group;r.add(B([2,3.5,4],[-1,.5,-2],M.vehicle)),r.add(B([2.2,2,2.5],[-1.1,1.3,-2.1],M.neon)),r.add(B([.5,.8,6],[-.5,2,2],M.vehicle)),t.add(B([12,.3,1],[-6,4,-.5],M.neon).rotateY(PI\/6)),t.add(B([1,.3,12],[-.5,4,-6],M.neon).rotateY(PI\/6)),r.add(t),o.add(B([3,.3,.7],[-1.5,-.15,-.35],M.neon).rotateZ(PI\/2).rotateY(PI\/4)),o.add(B([.7,.3,3],[-.35,-.15,-1.5],M.neon).rotateZ(PI\/2).rotateY(PI\/4)),o.position.set(0,2.5*grid,7*grid),r.add(o),r.add(B([1,.5,5],[-2,0,-2.5],M.vehicle)),r.add(B([1,.5,5],[1,0,-2.5],M.vehicle)),r.position.set(e.x*grid,400,e.z*grid),r.rotateY(prng(4)*PI\/2),G.add(r),H={h:r,a:t,ac:o,py:e.y*grid,y:400,v:-16,vg:0,p:0}}function tree(e,r,t){let o=M.tree2.clone();if(randTrees&&o.color.set(COL(prand(40,165),100,prand(40,70))),sakuraTrees){let e=COL(319,80,prand(75,96));o=new THREE.MeshLambertMaterial({color:e,emissive:e,emissiveIntensity:.4})}let n=prng(100)?o:M.tree3,a=sakuraTrees?3:2+prng(4),d=rtrees?prng(3):0;G.add(B([.8,6,.8],[e,r,t],M.tree1)),G.add(B([1,a,1],[e,r+4+d,t],n)),G.add(B([3,a,3],[e-1,r+3+d,t-1],n))}function pond(e,r,t,o){if(G.add(B([e.x,t,e.z],[r.x,r.y,r.z],M.walls)),Math.min(e.x,e.z)>=6){G.add(B([e.x-2,t+.2,e.z-2],[r.x+1,r.y,r.z+1],o)),G.add(B([1,t+.2,e.z-1],[r.x+e.x\/2,r.y,r.z-.5],o)),G.add(B([3,t+.2,1],[r.x-.5,r.y,r.z+e.z\/2],o));let n=prng(2);pond({x:e.x-3,y:e.y,z:e.z-3},{x:r.x+3*(1-n),y:r.y,z:r.z+3*n},t+2,o)}else if(eth){if(pal>2){let e=B([1,600,1],[r.x+1,r.y,r.z+1],new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,color:10092543,emissive:10092543,emissiveIntensity:2}));G.add(e),lights.push(e)}}else eth=s3D({x:r.x+e.x\/2,y:r.y+t+4.2,z:r.z+e.z\/2},3,4,2,1.6,new THREE.MeshPhongMaterial({color:ethcol,emissive:ethcol,emissiveIntensity:.2,flatShading:!0})),G.add(eth)}function tenp(e,r){let t=prng(3);for(let o=border;o<e.x-2;o+=2)for(let n,a=border;a<e.z-2;a+=2,n=prng(2))G.add(B([n?2:1,t+1.3,n?1:2],[r.x+o+1.5,r.y,r.z+a+1.5],M.cesped))}function park(e,r){let t=mMz(e.x-border-1,e.z-border-1),o=prng(4);for(let n=border;n<e.x-1;n++)for(let a=border;a<e.z-1;a++)t[n-border][a-border].w&&G.add(B([1,o+1.3,1],[r.x+n+.5,r.y,r.z+a+.5],M.cesped))}function mMz(e,r){let t=new Array(e);for(let e=0;e<t.length;e++){t[e]=new Array(r);for(let o=0;o<r;o++)t[e][o]={w:1,v:0}}mrec(t,e,r,1,1);let o=FL(e\/2)+1,n=FL(r\/2)+1;return t[0][n].w=0,t[e-1][n].w=0,t[o][0].w=0,t[o][r-1].w=0,t}function mrec(e,r,t,o,n,a=!1){if(o>=0&&n>=0&&o<r&&n<t&&!e[o][n].v){e[o][n].w=0,e[o][n].v=1,a&&(e[o-a[0]][n-a[1]].w=0);let d=[[0,-1],[1,0],[0,1],[-1,0]],i=prng(2);for(let e=0;e<i;e++){let e=prng(3),r=d[e];d[e]=d[e+1],d[e+1]=r}for(let a=0;a<4;a++)mrec(e,r,t,o+2*d[a][0],n+2*d[a][1],d[a])}}function b(e,r,t,o=-1,n=0,a=!0,d=!1){if(n&&G.add(B([e.x+n,n,e.z+n],[r.x-n\/2,1+r.y,r.z-n\/2],M.walls)),r.y+=n,G.add(B([e.x-2,t+1,e.z-2],[r.x+1,r.y+1,r.z+1],M.core)),-1!=o||prng(rf)?wallP(e,r,t,o):wallR(e,r,t),a&&prng(2)){let o=t<6||!d&&(t<8||prng(2)),n=o?5*prand(1,2):4+prng(4);e.x>e.z?cartel(e.x\/(prng(2)&&n<10?1:2),n,[r.x,r.y+t+(o?3:-(n-2)),r.z+(o?.5:-1)],0):cartel(e.z\/(prng(2)&&n<10?1:2),n,[r.z,r.y+t+(o?3:-(n-2)),r.x+(o?.5:-1)],1)}!d&&t>10&&prng(2)&&antenna({x:r.x-1,y:r.y+t+3,z:r.z-1},e.z>e.x)}function antenna(e,r){let t=1+prng(4);for(let o=1;o<=t;o++){let t=5+o,n=e.x+2.5*(r?1:o),a=e.z+2.5*(r?o:1);G.add(B([1.5,(1+prng(2))\/2,1.5],[n-.5,e.y,a-.5],M.core)),G.add(B([.5,t,.5],[n,e.y,a],M.walls)),G.add(B([.5,1,.5],[n,e.y+t,a],M.neon))}}function cartel(e,r,t,o=0){let n=prng(2)?M.neon:prng(2)?M.neon1:M.neon2;prng(5)||(n=n.clone(),lights.push(n)),G.add(B([e,r,.5],t,M.panel,o)),G.add(B([1,r,1],[t[0]+2,t[1],t[2]+.5],M.panel,o)),G.add(B([1,r,1],[t[0]+e-3,t[1],t[2]+.5],M.panel,o));for(let a=1;a<(e-1)\/2;a++)for(let d=1;d<r-1;d++)prng(3)&&(G.add(B([1,1,1],[t[0]+a,t[1]+d,t[2]-.3],n,o)),G.add(B([1,1,1],[t[0]+e-a-1,t[1]+d,t[2]-.3],n,o)))}function wallP(e,r,t,o=-1){let n=M.walls.clone();rainbowWalls&&n.color.set(ethpal[prng(ethpal.length)]);let a=-1==o?pats[prng(pats.length)]:o,d=a[0].length,i=a.length;for(let o=0;o<=t;o++){let t=o||2;for(let l=0;l<e.x\/2;l++)a[t%i][l%d]&&(G.add(B([1,1,1],[l+r.x,o+r.y+1,r.z],n)),G.add(B([1,1,1],[r.x+e.x-l-1,o+r.y+1,r.z],n)),l<3&&G.add(B([1,1,1],[l+r.x,o+r.y+1,r.z+e.z-1],n)));for(let l=1;l<e.z\/2;l++)a[t%i][l%d]&&(G.add(B([1,1,1],[r.x,o+r.y+1,l+r.z],n)),G.add(B([1,1,1],[r.x,o+r.y+1,r.z+e.z-l-1],n)),l<3&&G.add(B([1,1,1],[r.x+e.x-1,o+r.y+1,l+r.z],n)))}G.add(B([e.x,1,e.z],[r.x,2+r.y+t,r.z],n))}function wallR(e,r,t){let o=M.walls.clone();rainbowWalls&&o.color.set(ethpal[prng(ethpal.length)]);for(let n=0;n<=t;n++){for(let t=0;t<e.x;t++)(n%3==2||n%3==0&&0==prng(6))&&(G.add(B([1,n%3==2?1:2,1],[t+r.x,n+r.y+1,r.z],o)),t<3&&G.add(B([1,n%3==2?1:2,1],[t+r.x,n+r.y+1,r.z+e.z-1],o)));for(let t=0;t<e.z;t++)(n%3==2||n%3==0&&0==prng(6))&&(G.add(B([1,n%3==2?1:2,1],[r.x,n+r.y+1,t+r.z],o)),t<3&&G.add(B([1,n%3==2?1:2,1],[r.x+e.x-1,n+r.y+1,t+r.z],o)))}G.add(B([e.x,1,e.z],[r.x,2+r.y+t,r.z],o))}function s3D(e,r,t,o,n,a){let d=new THREE.Mesh(new THREE.SphereGeometry(r*grid,t,o),a);return d.position.set(e.x*grid,e.y*grid,e.z*grid),d.scale.set(1,n,1),d}function B(e,r,t,o=0){let n=e[o?2:0],a=e[1],d=e[o?0:2],i=r[o?2:0],l=r[1],s=r[o?0:2],p=new THREE.BoxGeometry(n*grid+.1,a*grid+.1,d*grid+.1),x=new THREE.Mesh(p,t);x.position.set((i+n\/2)*grid,(l+a\/2)*grid,(s+d\/2)*grid),n\/=5;var g=[d\/=4,0,d,a\/=4,0,a,0,0,...o?[d,n,0,n,0,0,d,0]:[0,d,0,0,n,0,n,d],n,0,n,a,0,a,0,0];p.faceVertexUvs[0]=[];for(let e=0;e<3;e++){let r=8*e;for(let e=0;e<2;e++)p.faceVertexUvs[0].push([V2(g[r],g[r+1]),V2(g[r+2],g[r+3]),V2(g[r+6],g[r+7])]),p.faceVertexUvs[0].push([V2(g[r+2],g[r+3]),V2(g[r+4],g[r+5]),V2(g[r+6],g[r+7])])}return p.uvsNeedUpdate=!0,x}var mH=0,mouseD=!1;document.addEventListener(\"mousedown\",e=>{mouseD=!0}),document.addEventListener(\"mouseup\",e=>{mouseD=!1,rotX=RX,rotY=RY}),document.addEventListener(\"mousemove\",e=>{mH=0,mouseD&&(rotX=Math.max(Math.min(rotX+.004*e.movementY,RX+.4),RX-.4),rotY=Math.max(Math.min(rotY+.004*e.movementX,RY+.4),RY-.4))}),document.addEventListener(\"keypress\",e=>{\"1\"==e.key?(rotX=0,rotY=PI):\"2\"==e.key?(rotX=0,rotY=.75*PI):\"3\"==e.key?(rotX=0,rotY=PI\/2):(rotX=RX,rotY=RY),\"0\"==e.key&&(R.setClearColor(0,0),bgplane.visible=!bgplane.visible)}),window.addEventListener(\"resize\",function(){let e=window.innerWidth,r=window.innerHeight;C.left=-e\/2,C.right=e\/2,C.top=r\/2,C.bottom=-r\/2,C.zoom=Math.min(e,r)\/scale,C.updateProjectionMatrix(),R.setSize(e,r),post.resize()});var vaspa=10;function animate(){let e=clock.getDelta();mH+=e,R.domElement.style.cursor=mH>3?\"none\":\"default\";for(let e of lights)e.emissiveIntensity=prng(16)?2:0;if(e<.3){moveCar(e),m.uniforms.dt.value+=.5*e;for(let r of ele)r.delay<=0?(r.stop-=e,r.stop<=0&&(r.stop=4+prng(4),r.dir=prng(2)?5:-5,r.delay=2+prng(3)),r.model.position.y+=e*r.dir,(r.model.position.y>r.maxy||r.model.position.y<r.miny)&&(r.model.position.y=r.model.position.y>r.maxy?r.maxy:r.miny,r.dir*=-1)):r.delay-=e;for(let r of trains)r.d-=e,r.broken-=e,r.broken<=0&&(r.broken=r.w?1+prng(3):prand(20,120),r.w=!r.w),r.w&&r.d<=0?(r.w&&(r.m.emissiveIntensity=2),r.z?r.t.position.z+=r.v*e:r.t.position.x+=r.v*e,!r.z&&(r.t.position.x>(gx-r.l)*grid||r.t.position.x<10)&&(r.v=-r.v,r.t.position.x+=r.v*e,r.d=prng(3)),r.z&&(r.t.position.z>(gz-r.l)*grid||r.t.position.z<10)&&(r.v=-r.v,r.t.position.z+=r.v*e,r.d=prng(3))):r.w||(r.m.emissiveIntensity=prng(10)\/10);if(H)if(H.p-=e,H.a.rotation.y+=vaspa*e,H.ac.rotation.x-=1.3*vaspa*e,H.p<=0){if((vaspa=Math.min(10,vaspa+e))>=10){let r=Math.min(1,.1+(H.h.position.y-H.py)\/40);H.h.rotation.y+=.2*r*e,H.h.position.y+=r*H.v*e,H.h.position.y>400&&(H.v*=-1),H.h.position.y<=H.py&&(H.h.position.y=H.py,H.v*=-1,H.p=10)}}else vaspa=Math.max(0,vaspa-4*e);eth&&(eth.rotation.y+=e),tex1.offset.y-=e,city.rotation.x+=(rotX-city.rotation.x)\/5,city.rotation.y+=(rotY-city.rotation.y)\/5}post.render(SC,C),requestAnimationFrame(animate)}function generateTexture(){let e=32,r=document.createElement(\"canvas\");r.width=r.height=e;let t=r.getContext(\"2d\");t.fillStyle=\"#ffffff\",t.fillRect(0,0,e,e),t.fillStyle=\"#aaaaaa99\";for(let r=0;r<=e;r+=4)t.fillRect(r,prng(e\/3+ABS(16-r)),2,8),t.fillRect(r,prng(e+ABS(16-r)),1,8);return r}animate();"
}